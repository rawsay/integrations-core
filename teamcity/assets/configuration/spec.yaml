name: Teamcity
files:
- name: teamcity.yaml
  options:
  - template: init_config
    options:
    - template: init_config/default
  - template: instances
    options:
    - name: server
      required: true
      description: |
        Specify the server name of your TeamCity instance.
        Enable Guest Authentication on your instance or enable the
        optional `basic_http_authentication` config param to collect data.
        If using `basic_http_authentication`, specify:

        server: http://<USER>:<PASSWORD>@teamcity.<ACCOUNT_NAME>.com
      value:
        type: string
        example: http://teamcity.<ACCOUNT_NAME>.com
    - name: basic_http_authentication
      description: |
        Set to true to turn on basic http authentication.
      value:
        type: boolean
        default: false
        example: false
    - name: use_openmetrics
      description: |
        Use the latest OpenMetrics V2 implementation to collect metrics from
        the TeamCity server's prometheus metrics endpoint.
        Requires Python version 3.

        Enable in a separate instance to collect prometheus metrics.
        This option does not collect events, service checks, or metrics from the TeamCity REST API.
      value:
        type: boolean
        default: false
        example: false
    - name: experimental_metrics
      description: |
        Enable collection of experimental TeamCity Prometheus metrics.
        See https://www.jetbrains.com/help/teamcity/teamcity-monitoring-and-diagnostics.html#Metrics
        Only available with `use_openmetrics: true`.
      value:
        type: boolean
        default: false
        example: false
    - name: collect_events
      description: |
        Enable collection of TeamCity build and deployment success and failure events.
        Not available with `use_openmetrics: true`.
      value:
        type: boolean
        default: true
        example: true
    - name: name
      description: |
        A custom unique name per build configuration that is shown
        in the events. If omitted, the build configuration ID is used.
      value:
        type: string
        example: <BUILD_NAME>
    - name: projects
      description: |
        Mapping of TeamCity projects and build configurations to
        collect events and metrics from the TeamCity REST API.

        The mapping must be configured with Project IDs as the top-level keys. Each Project ID key value
        may be configured with a mapping of the optional `include` and `exclude` keys to specify
        Build Configuration ID REGEX match patterns. If `include` and `exclude` keys are omitted,
        all Build Configurations per specified Project ID is collected.
        Patterns specified in the `exclude` take precedence in case of overlap.

        * To collect all build configurations per Project ID, configure an empty mapping value:
            projects:
             <PROJECT_ID>:

        * To filter build configurations in each configured Project, use the optional `include` and/or `exclude` keys
          to configure a list of Build Configuration ID REGEX matching patterns:
            projects:
              <PROJECT_ID>:
                include:
                  - <BUILD_CONFIG_ID_REGEX>
                  - <BUILD_CONFIG_ID_REGEX>
                exclude:
                  - <BUILD_CONFIG_ID_REGEX>
      value:
        type: object
        additional_properties:
          type: object
          optional:
            - include
            - exclude
          properties:
          - name: include
            type: array
            items:
              type: str
          - name: exclude
            type: array
            items:
              type: str
        example:
          <PROJECT_A>:
            include:
              - <BUILD_CONFIG_A>
              - <BUILD_CONFIG_B>
            exclude:
              - <BUILD_CONFIG_C>
          <PROJECT_B>: {}
    - name: build_config_metrics
      description: |
        Collect Build Configuration statistics per build.
        Not available with `use_openmetrics: true`.
      value:
        type: boolean
        default: true
        example: true
    - name: test_result_metrics
      description: |
        Collect test result statistics per build.
        Not available with `use_openmetrics: true`.
      value:
        type: boolean
        default: true
        example: true
    - name: build_problem_checks
      description: |
        Collect build problem service checks.
        Not available with `use_openmetrics: true`.
      value:
        type: boolean
        default: true
        example: true
    - name: build_configuration
      description: |
        [DEPRECATED] This is the internal build ID of the build configuration you wish to track.
        You can find it labeled as "Build configuration ID" when editing the configuration in question.

        Configure only one of `projects` or `build_configuration` per instance.
      value:
        type: string
    - name: is_deployment
      description: |
        [DEPRECATED] Set to true to modify the event message to indicate that the TeamCity build configuration
        is a deployment rather than a build run. Best used with the `build_configuration` option only.
        If used with the `projects` option, all events from collected build configurations are affected.
        Not available with `use_openmetrics: true`.
      value:
        type: boolean
        default: false
        example: false
    - name: host_affected
      description: |
        [DEPRECATED] Use this parameter to override the hostname that is affected by the build configuration(s)
        in the event message. Defaults to the host that the agent is running on.
        Not available with `use_openmetrics: true`.
      value:
        type: string
    - template: instances/openmetrics
      overrides:
        openmetrics_endpoint.hidden: true
        openmetrics_endpoint.required: false
  - template: logs
    example:
    - type: file
      path: /opt/teamcity/logs/teamcity-server.log
      source: teamcity
    - type: file
      path: /opt/teamcity/logs/teamcity-activities.log
      source: teamcity
    - type: file
      path: /opt/teamcity/logs/teamcity-vcs.log
      source: teamcity
    - type: file
      path: /opt/teamcity/logs/teamcity-cleanup.log
      source: teamcity
    - type: file
      path: /opt/teamcity/logs/teamcity-notifications.log
      source: teamcity
    - type: file
      path: /opt/teamcity/logs/teamcity-ws.log
      source: teamcity
